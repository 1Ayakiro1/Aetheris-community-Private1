import{an as C,a8 as g}from"./index-QOySC_5N.js";import{r as _,c as x,b as S,u as k,d as b,e as E,f as P,h as $}from"./articles-aP_knVEN.js";const u=g([]),l=g(!1),a=g(null);function M(e,c=1400){if(!e)return"";const m=e.replace(/<[^>]+>/g,"");return m.length>c?m.slice(0,c).trimEnd():m}function i(){const e="anon_user_id";let c=localStorage.getItem(e);return c||(c=String(Date.now()+Math.floor(Math.random()*1e4)),localStorage.setItem(e,c)),Number(c)}function d(e){return{id:e.id,title:e.title,content:e.content,excerpt:e.excerpt||M(e.content),author:{id:Number(e.author?.id)||0,username:e.author?.username||(typeof e.author=="string"?e.author:`User ${e.author}`)},tags:Array.isArray(e.tags)?e.tags:typeof e.tags=="string"?e.tags.split(","):[],createdAt:e.created_at||e.createdAt,status:e.status||"published",difficulty:e.difficulty||"medium",likes:e.likes??0,dislikes:e.dislikes??0,commentsCount:e.comments_count??e.commentsCount??0,userReaction:e.user_reaction??null,previewImage:e.preview_image||e.previewImage||null}}function D(){const e=C();async function c(){l.value=!0,a.value=null;try{const t=i(),r=await $(t);u.value=r.map(d)}catch(t){a.value=t.message||"Ошибка загрузки"}finally{l.value=!1}}async function m(t,r){try{const n=i(),s=await P(t,n,r),o=d(s),f=u.value.findIndex(I=>I.id===t);return f!==-1&&(u.value[f]=o),o}catch(n){throw console.error("Ошибка при реакции",n),n}}async function A(t){try{const r=i(),n=await E(t,r);return d(n)}catch(r){throw console.error("Ошибка при загрузке статьи",r),r}}async function h(t){try{l.value=!0,a.value=null;const r={...t,author:e.user?.username||t.author||"Anonymous"},n=await b(r);console.log("API вернул article:",n);const s=d(n);return u.value.unshift(s),console.log("rawArticle из API:",s),s}catch(r){throw a.value=r.message||"Ошибка API при создании статьи",console.error(a.value),new Error(String(a.value))}finally{l.value=!1}}async function v(t,r){try{l.value=!0,a.value=null;const n=await k(t,r),s=d(n),o=u.value.findIndex(f=>f.id===t);return o!==-1&&(u.value[o]=s),s}catch(n){throw a.value=n.message||"Ошибка API при обновлении статьи",console.error(a.value),new Error(String(a.value))}finally{l.value=!1}}async function y(t){const r=i();return await S(t,r)}async function p(t,r,n){const s=e.user?.id??i(),o=e.user?.username||"Guest";return await x(t,{text:r,parent_id:n??null,author_id:s,author_name:o})}async function w(t,r){const n=i();return await _(t,n,r)}return{articles:u,loading:l,error:a,fetchArticles:c,react:m,getArticle:A,createArticle:h,updateArticle:v,fetchComments:y,addComment:p,reactCommentFn:w}}export{D as u};
